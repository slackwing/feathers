# CLAUDE.md - Development Guide for AI Assistants

## ⚠️ CRITICAL: DO NOT RUN --fix ON EXAMPLE FILES

**NEVER run `python3 -m tools.sxiva.cli calculate examples/calculated/*.sxiva --fix`**

- Use `./regenerate.sh` instead - it handles all examples correctly
- For testing, output to `/tmp/` or examine `examples/calculated/` after running `./regenerate.sh`
- The calculated examples are the source of truth for verifying correctness

---

This document explains the SXIVA project structure, testing workflow, and critical maintenance practices for AI assistants working on this codebase.

## Project Overview

SXIVA is a time-tracking notation language with:
- **Grammar**: Tree-sitter grammar for parsing `.sxiva` files
- **Calculator**: Python tool that computes point calculations based on timing, focus, and accumulation
- **Neovim Plugin**: Syntax highlighting and file type detection
- **Examples**: Source `.sxiva` files used for testing and documentation

## Examples Structure

### Source Examples (`examples/*.sxiva`)

All example files live directly in `examples/`:

```
examples/
├── basic.sxiva                    # Basic time tracking
├── single-blick.sxiva             # Single blick blocks
├── continuations.sxiva            # Continuation chains
├── continuation-x-blocks.sxiva    # X-block continuations
├── x-blocks.sxiva                 # Shortened blocks
├── start-blocks.sxiva             # 4-blick start blocks
├── breaks-and-rest.sxiva          # Break markers (;;;) and rest ([...])
├── focus-changes.sxiva            # Focus declaration changes
├── rest-blocks.sxiva              # Rest block examples
├── tilde-shorthand.sxiva          # Tilde syntax shortcuts
├── whitespace-and-separators.sxiva
├── accumulation-rollover.sxiva    # +10a wrapping behavior
├── complex-categories.sxiva       # Multi-word categories
├── edge-cases.sxiva               # Time overlaps, edge scenarios
├── full-day.sxiva                 # Complete day example
├── unpointed.sxiva                # Incomplete (no points)
└── INVALID-test-errors.sxiva      # Intentional syntax errors
```

**Key Points:**
- These are the **source of truth** for examples
- They DO NOT contain point calculations (except calculated/ versions)
- They MUST have correct syntax per `docs/SPECS.md`
- Rest blocks MUST include duration: `[...] (description) (minutes)`

### Generated Examples (`examples/calculated/*.sxiva`)

The `calculated/` directory contains auto-generated versions with complete point calculations:

```
examples/calculated/
├── basic.sxiva                    # With points: --- 14:02 (-2,+2f,+1a=1)
├── single-blick.sxiva
├── ... (same filenames as source)
```

**Key Points:**
- These are **generated automatically** from source examples
- They contain complete point notation: `(base,+focus,+accumulation=running_total)`
- NEVER edit these files manually
- Regenerated by running the test suite

## Testing Workflow

### ⚠️ CRITICAL: NEVER Run --fix on Source Examples!

**ALWAYS use `./regenerate.sh` to update calculated examples. NEVER run `--fix` on files in `examples/` directly!**

❌ **WRONG:**
```bash
# DO NOT DO THIS - modifies source examples!
python3 -m tools.sxiva.cli calculate examples/basic.sxiva --fix
for file in examples/*.sxiva; do python3 -m tools.sxiva.cli calculate "$file" --fix; done
```

✅ **CORRECT:**
```bash
# Use regenerate.sh - only touches examples/calculated/
./regenerate.sh
```

### Quick Regeneration (Recommended)

From the project root, run:

```bash
./regenerate.sh
```

This regenerates all `examples/calculated/*.sxiva` files from source examples. Use this after:
- Modifying calculator logic
- Fixing source examples
- Making any changes to point calculation rules

**What regenerate.sh does:**
1. Reads source `.sxiva` files from `examples/`
2. Copies them to `examples/calculated/` with point calculations added
3. **NEVER touches the original files in `examples/`**

### Running Tests

```bash
cd /path/to/sxiv
python3 tests/test_examples.py
```

**What the test does:**
1. Reads all source `.sxiva` files from `examples/`
2. Generates calculated versions to `examples/calculated/`
3. Validates that calculated versions pass point verification
4. Reports pass/fail for each file

**Expected Output:**
```
✓ ALL VALID EXAMPLES PASS!
  15/15 files have correct point calculations
```

### Manual Calculation (for inspection only)

```bash
# Check if points are correct (read-only, just reports)
python3 -m tools.sxiva.cli calculate examples/basic.sxiva

# ONLY use --fix on calculated/ files, NEVER on examples/ files!
python3 -m tools.sxiva.cli calculate examples/calculated/basic.sxiva --fix

# Or better: just use ./regenerate.sh
./regenerate.sh
```

## Critical Maintenance Rules

### 1. ALWAYS Keep SPECS.md Updated

**`docs/SPECS.md` is the single source of truth for:**
- Language grammar and syntax
- Point calculation rules (base, focus, accumulation)
- Time offset handling across breaks
- Block type thresholds (standard: 12 min, x1: 3 min, x2: 6 min, start4: 16 min)
- Continuation chain behavior
- Break behavior (`;;;` vs `[...]`)

**When to update SPECS.md:**
- ✅ Grammar changes (new syntax, modified rules)
- ✅ Calculation changes (formulas, thresholds, offsets)
- ✅ Break/rest block behavior changes
- ✅ Accumulation or focus point rule changes
- ✅ ANY change that affects how `.sxiva` files are parsed or calculated

**Why this matters:**
- SPECS.md allows regenerating the entire algorithm from scratch
- It documents edge cases and corner case handling
- It serves as the contract between parser, calculator, and users
- Future AI assistants can rebuild logic from SPECS.md alone

### 2. ALWAYS Regenerate Examples After Calculator/Tooling Changes

⚠️ **CRITICAL:** Whenever you modify `tools/sxiva/calculator.py`, `tools/sxiva/parser.py`, or any calculation/tooling logic:

```bash
# ALWAYS regenerate all calculated examples immediately
python3 tests/test_examples.py
```

**After modifying calculator logic:**
```bash
# Regenerate all calculated examples
python3 tests/test_examples.py
```

**After modifying source examples:**
```bash
# Same command - test suite regenerates calculated/
python3 tests/test_examples.py
```

**After modifying grammar:**
```bash
cd grammar
npx tree-sitter generate
gcc -o parser.so -shared src/parser.c -I./src -fPIC -O2
cd ..
python3 tests/test_examples.py
```

This ensures `examples/calculated/*.sxiva` stays in sync with the current algorithm.

### 3. Common Pitfalls

#### Pitfall: Editing `calculated/` Instead of Source

❌ **WRONG:**
```bash
# Editing calculated version
vim examples/calculated/edge-cases.sxiva
```

✅ **CORRECT:**
```bash
# Edit source, then regenerate
vim examples/edge-cases.sxiva
python3 tests/test_examples.py
```

#### Pitfall: Forgetting Break Durations

❌ **WRONG:**
```sxiva
[...] (lunch)
```

✅ **CORRECT:**
```sxiva
[...] (lunch) (48)
```

Rest blocks REQUIRE the duration parameter (must be multiple of 12).

#### Pitfall: Not Testing After Grammar Changes

After modifying `grammar/grammar.js`:
```bash
cd grammar
npx tree-sitter generate
gcc -o parser.so -shared src/parser.c -I./src -fPIC -O2
python3 ../tests/test_examples.py
```

## Key Files Reference

| File | Purpose |
|------|---------|
| `docs/SPECS.md` | **Language specification (SOURCE OF TRUTH)** |
| `grammar/grammar.js` | Tree-sitter grammar definition |
| `tools/sxiva/calculator.py` | Point calculation engine |
| `tools/sxiva/parser.py` | Tree-sitter wrapper |
| `tests/test_examples.py` | Example validation suite |
| `examples/*.sxiva` | Source examples (no points) |
| `examples/calculated/*.sxiva` | Generated examples (with points) |

## Algorithm Regeneration Process

If you need to rebuild the calculator from scratch:

1. **Read `docs/SPECS.md`** - Complete language specification
2. **Understand the state machine:**
   - `CalculationState`: tracks `running_total`, `accumulation`, `focus_categories`, `time_offset`, `previous_end_time`
   - Process nodes sequentially (top-to-bottom)
   - Update state after each block
3. **Key calculation rules:**
   - Base points: `expected_end - actual_end` where `expected_end = previous_end + threshold` (or `start + threshold + offset` after breaks)
   - Focus points: `+1f` per unique focus category match (not for x-blocks)
   - Accumulation points: `+1a` to `+10a` streak (wraps), only with focus, not for x-blocks
   - Time offset: `actual_end - (block_start + 12)`, preserved across breaks
4. **Test thoroughly:**
   ```bash
   python3 tests/test_examples.py
   ```
   All 15 valid examples must pass.

## Debugging Tips

### Points Don't Match

```bash
# See what calculator expects
python3 -m tools.sxiva.cli calculate examples/edge-cases.sxiva

# Common causes:
# - Time offset not preserved across breaks
# - Accumulation reset incorrectly
# - Focus categories not matching
# - Continuation chain threshold wrong (should be 12 for final block)
```

### Parser Errors

```bash
# Check grammar is compiled
ls grammar/parser.so

# Recompile if needed
cd grammar
npx tree-sitter generate
gcc -o parser.so -shared src/parser.c -I./src -fPIC -O2
```

### Test Failures

```bash
# Run tests with full output
python3 tests/test_examples.py

# Check specific file
python3 -m tools.sxiva.cli calculate examples/problematic-file.sxiva
```

## Verifying Calculated Examples

**Important:** The user only commits `examples/calculated/` files after manually verifying they are correct.

Use this workflow to check if your changes affected the output:

```bash
# After making changes, regenerate calculated examples
./regenerate.sh

# Check what changed
git status examples/calculated/
git diff examples/calculated/

# Analyze the changes:
# - Are they expected based on your modifications?
# - Are the calculations correct?
# - Do summaries show proper time totals?
```

This allows you to:
1. See exactly what output changed
2. Verify if changes are intentional or bugs
3. Catch regressions before committing

## Summary Checklist

Before committing changes:

- [ ] Updated `docs/SPECS.md` if grammar or calculations changed
- [ ] **Ran `./regenerate.sh` to update all calculated examples**
- [ ] **Used `git diff examples/calculated/` to verify output is correct**
- [ ] **Ran `python3 tests/test_examples.py` and all tests pass**
- [ ] Checked that rest blocks have duration: `[...] (desc) (mins)`
- [ ] Confirmed point calculations match expected behavior
- [ ] No manual edits to `examples/calculated/*.sxiva` files

**Critical Reminders:**
1. **SPECS.md is the source of truth** - Keep it updated and detailed enough to regenerate everything from scratch
2. **ALWAYS regenerate `examples/calculated/`** after any calculator or tooling changes
3. **Use `git diff` to verify calculated output** - User only commits after manual verification
4. Time overlaps are VALID in SXIVA (indented accumulation blocks can overlap)
5. Test suite must show all valid examples pass
